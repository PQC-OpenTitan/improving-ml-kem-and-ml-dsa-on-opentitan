#!/bin/bash

set -e -x

# echo ""
# echo $1
# echo ""
# echo $2
# echo ""
# echo $3
# echo ""
# echo $4
# echo ""



#pwd

#ls ~/src/otbn/expo-otbn-pqc/$1
#
#cat $1

#which sv2v

#echo $PATH

sv2v --define=SYNTHESIS \
   --define=SYNTHESIS_MEMORY_BLACK_BOXING --define=YOSYS \
   $5 \
   $3 \
   $4 \
   $1 \
   > $2

# Make sure auto-generated primitives are resolved to generic or Xilinx-specific primitives
# where available.
sed -i 's/prim_flop/prim_xilinx_flop/g'              $2
sed -i 's/prim_xilinx_flop_2sync/prim_generic_flop_2sync/g' $2
sed -i 's/prim_sec_anchor_flop/prim_xilinx_flop/g'   $2
sed -i 's/prim_buf/prim_xilinx_buf/g'                $2
sed -i 's/prim_sec_anchor_buf/prim_xilinx_buf/g'     $2
sed -i 's/prim_xor2/prim_xilinx_xor2/g'              $2
sed -i 's/prim_xnor2/prim_xilinx_xnor2/g'            $2
sed -i 's/prim_and2/prim_xilinx_and2/g'              $2
sed -i 's/prim_ram_1p/prim_generic_ram_1p/g'         $2

# Remove calls to $value$plusargs(). Yosys doesn't seem to support this.
sed -i '/$value$plusargs(.*/d' $2

if [ "$2" = "src/prim_sparse_fsm_flop.v" ]; then
  # Rename the prim_sparse_fsm_flop module. For some reason, sv2v decides to append a suffix.
  sed -i 's/module prim_sparse_fsm_flop_.*/module prim_sparse_fsm_flop \(/g' $2
fi

# Rename prim_sparse_fsm_flop instances. For some reason, sv2v decides to append a suffix.
sed -i 's/prim_sparse_fsm_flop_.*/prim_sparse_fsm_flop \#(/g' $2

# Remove the StateEnumT parameter from prim_sparse_fsm_flop instances. Yosys doesn't seem to
# support this.
sed -i '/\.StateEnumT(logic \[.*/d' $2
sed -i '/\.StateEnumT_otbn_pkg.*Width.*(.*/d' $2

