// Brent-Kung adder based conditional subtraction.
// A - B >= 0 ? A - B : A

module cond_sub (
    input  logic [255:0] A,
    input  logic [255:0] B,
    input  logic         word_mode,   // 0: vec16, 1: vec32
    input  logic         cin,
    output logic [255:0] sum,
    output logic         cout
);

    logic [255:0] G, P;
    logic [256:0] C;

    // Step 1: Btwise G/P
    genvar i;
    generate
        for (i = 0; i < 256; i++) begin : gp_gen
            assign G[i] = A[i] & (~B[i]);
            assign P[i] = A[i] ^ (~B[i]);
        end
    endgenerate

    // Step 2: Up-sweep: compute group prefixes at sparse nodes
    // Tree level wires
    logic [255:0] G1, G2, G3, G4, G5;
    logic [255:0] P1, P2, P3, P4, P5;

    // Level 1 (distance 1)
    generate
        for (i = 0; i < 256; i++) begin
            if (i >= 1 && (i & 1) == 1) begin : gen_1
                assign G1[i] = G[i] | (P[i] & G[i-1]);
                assign P1[i] = P[i] & P[i-1];
            end else begin : gen_1
                assign G1[i] = G[i];
                assign P1[i] = P[i];
            end
        end
    endgenerate

    // Level 2 (distance 2)
    generate
        for (i = 0; i < 256; i++) begin
            if (i >= 3 && (i & 3) == 3) begin : gen_2l
                assign G2[i] = G1[i] | (P1[i] & G1[i-2]);
                assign P2[i] = P1[i] & P1[i-2];
            end else begin : gen_2
                assign G2[i] = G1[i];
                assign P2[i] = P1[i];
            end
        end
    endgenerate

    // Level 3 (distance 4)
    generate
        for (i = 0; i < 256; i++) begin
            if (i >= 7 && (i & 7) == 7) begin : gen_3l
                assign G3[i] = G2[i] | (P2[i] & G2[i-4]);
                assign P3[i] = P2[i] & P2[i-4];
            end else begin : gen_3
                assign G3[i] = G2[i];
                assign P3[i] = P2[i];
            end
        end
    endgenerate

    // Level 4 (distance 8)
    generate
        for (i = 0; i < 256; i++) begin
            if (i >= 15 && (i & 15) == 15) begin : gen_4l
                assign G4[i] = G3[i] | (P3[i] & G3[i-8]);
                assign P4[i] = P3[i] & P3[i-8];
            end else begin : gen_4
                assign G4[i] = G3[i];
                assign P4[i] = P3[i];
            end
        end
    endgenerate

    // Level 5 (distance 16)
    generate
        for (i = 0; i < 256; i++) begin
            if (i >= 31 && (i & 31) == 31) begin : gen_5l
                assign G5[i] = (word_mode == 1'b1) ? (G4[i] | (P4[i] & G4[i-16])) : G4[i];
                assign P5[i] = (word_mode == 1'b1) ? (P4[i] & P4[i-16])           : P4[i];
            end else begin : gen_5
                assign G5[i] = G4[i];
                assign P5[i] = P4[i];
            end
        end
    endgenerate

    // Step 3: Down-sweep â€” assign carries using prefix fanout
    always_comb begin
        C[  0] = cin;
        C[  1] = G5[  0] | (P4[  0] & C[  0]);
        C[  2] = G5[  1] | (P4[  1] & C[  0]);
        C[  3] = G5[  2] | (P4[  2] & C[  2]);
        C[  4] = G5[  3] | (P4[  3] & C[  0]);
        C[  5] = G5[  4] | (P4[  4] & C[  4]);
        C[  6] = G5[  5] | (P4[  5] & C[  4]);
        C[  7] = G5[  6] | (P4[  6] & C[  6]);
        C[  8] = G5[  7] | (P4[  7] & C[  0]);
        C[  9] = G5[  8] | (P4[  8] & C[  8]);
        C[ 10] = G5[  9] | (P4[  9] & C[  8]);
        C[ 11] = G5[ 10] | (P4[ 10] & C[ 10]);
        C[ 12] = G5[ 11] | (P4[ 11] & C[  8]);
        C[ 13] = G5[ 12] | (P4[ 12] & C[ 12]);
        C[ 14] = G5[ 13] | (P4[ 13] & C[ 12]);
        C[ 15] = G5[ 14] | (P4[ 14] & C[ 14]);
        C[ 16] = (word_mode == 1'b1) ? (G5[ 15] | (P4[ 15] & cin)) : cin;
        C[ 17] = G5[ 16] | (P4[ 16] & C[ 16]);
        C[ 18] = G5[ 17] | (P4[ 17] & C[ 16]);
        C[ 19] = G5[ 18] | (P4[ 18] & C[ 18]);
        C[ 20] = G5[ 19] | (P4[ 19] & C[ 16]);
        C[ 21] = G5[ 20] | (P4[ 20] & C[ 20]);
        C[ 22] = G5[ 21] | (P4[ 21] & C[ 20]);
        C[ 23] = G5[ 22] | (P4[ 22] & C[ 22]);
        C[ 24] = G5[ 23] | (P4[ 23] & C[ 16]);
        C[ 25] = G5[ 24] | (P4[ 24] & C[ 24]);
        C[ 26] = G5[ 25] | (P4[ 25] & C[ 24]);
        C[ 27] = G5[ 26] | (P4[ 26] & C[ 26]);
        C[ 28] = G5[ 27] | (P4[ 27] & C[ 24]);
        C[ 29] = G5[ 28] | (P4[ 28] & C[ 28]);
        C[ 30] = G5[ 29] | (P4[ 29] & C[ 28]);
        C[ 31] = G5[ 30] | (P4[ 30] & C[ 30]);
        C[ 32] = cin;
        C[ 33] = G5[ 32] | (P4[ 32] & C[ 32]);
        C[ 34] = G5[ 33] | (P4[ 33] & C[ 32]);
        C[ 35] = G5[ 34] | (P4[ 34] & C[ 34]);
        C[ 36] = G5[ 35] | (P4[ 35] & C[ 32]);
        C[ 37] = G5[ 36] | (P4[ 36] & C[ 36]);
        C[ 38] = G5[ 37] | (P4[ 37] & C[ 36]);
        C[ 39] = G5[ 38] | (P4[ 38] & C[ 38]);
        C[ 40] = G5[ 39] | (P4[ 39] & C[ 32]);
        C[ 41] = G5[ 40] | (P4[ 40] & C[ 40]);
        C[ 42] = G5[ 41] | (P4[ 41] & C[ 40]);
        C[ 43] = G5[ 42] | (P4[ 42] & C[ 42]);
        C[ 44] = G5[ 43] | (P4[ 43] & C[ 40]);
        C[ 45] = G5[ 44] | (P4[ 44] & C[ 44]);
        C[ 46] = G5[ 45] | (P4[ 45] & C[ 44]);
        C[ 47] = G5[ 46] | (P4[ 46] & C[ 46]);
        C[ 48] = (word_mode == 1'b1) ? (G5[ 47] | (P4[ 47] & cin)) : cin;
        C[ 49] = G5[ 48] | (P4[ 48] & C[ 48]);
        C[ 50] = G5[ 49] | (P4[ 49] & C[ 48]);
        C[ 51] = G5[ 50] | (P4[ 50] & C[ 50]);
        C[ 52] = G5[ 51] | (P4[ 51] & C[ 48]);
        C[ 53] = G5[ 52] | (P4[ 52] & C[ 52]);
        C[ 54] = G5[ 53] | (P4[ 53] & C[ 52]);
        C[ 55] = G5[ 54] | (P4[ 54] & C[ 54]);
        C[ 56] = G5[ 55] | (P4[ 55] & C[ 48]);
        C[ 57] = G5[ 56] | (P4[ 56] & C[ 56]);
        C[ 58] = G5[ 57] | (P4[ 57] & C[ 56]);
        C[ 59] = G5[ 58] | (P4[ 58] & C[ 58]);
        C[ 60] = G5[ 59] | (P4[ 59] & C[ 56]);
        C[ 61] = G5[ 60] | (P4[ 60] & C[ 60]);
        C[ 62] = G5[ 61] | (P4[ 61] & C[ 60]);
        C[ 63] = G5[ 62] | (P4[ 62] & C[ 62]);
        C[ 64] = cin;
        C[ 65] = G5[ 64] | (P4[ 64] & C[ 64]);
        C[ 66] = G5[ 65] | (P4[ 65] & C[ 64]);
        C[ 67] = G5[ 66] | (P4[ 66] & C[ 66]);
        C[ 68] = G5[ 67] | (P4[ 67] & C[ 64]);
        C[ 69] = G5[ 68] | (P4[ 68] & C[ 68]);
        C[ 70] = G5[ 69] | (P4[ 69] & C[ 68]);
        C[ 71] = G5[ 70] | (P4[ 70] & C[ 70]);
        C[ 72] = G5[ 71] | (P4[ 71] & C[ 64]);
        C[ 73] = G5[ 72] | (P4[ 72] & C[ 72]);
        C[ 74] = G5[ 73] | (P4[ 73] & C[ 72]);
        C[ 75] = G5[ 74] | (P4[ 74] & C[ 74]);
        C[ 76] = G5[ 75] | (P4[ 75] & C[ 72]);
        C[ 77] = G5[ 76] | (P4[ 76] & C[ 76]);
        C[ 78] = G5[ 77] | (P4[ 77] & C[ 76]);
        C[ 79] = G5[ 78] | (P4[ 78] & C[ 78]);
        C[ 80] = (word_mode == 1'b1) ? (G5[ 79] | (P4[ 79] & cin)) : cin;
        C[ 81] = G5[ 80] | (P4[ 80] & C[ 80]);
        C[ 82] = G5[ 81] | (P4[ 81] & C[ 80]);
        C[ 83] = G5[ 82] | (P4[ 82] & C[ 82]);
        C[ 84] = G5[ 83] | (P4[ 83] & C[ 80]);
        C[ 85] = G5[ 84] | (P4[ 84] & C[ 84]);
        C[ 86] = G5[ 85] | (P4[ 85] & C[ 84]);
        C[ 87] = G5[ 86] | (P4[ 86] & C[ 86]);
        C[ 88] = G5[ 87] | (P4[ 87] & C[ 80]);
        C[ 89] = G5[ 88] | (P4[ 88] & C[ 88]);
        C[ 90] = G5[ 89] | (P4[ 89] & C[ 88]);
        C[ 91] = G5[ 90] | (P4[ 90] & C[ 90]);
        C[ 92] = G5[ 91] | (P4[ 91] & C[ 88]);
        C[ 93] = G5[ 92] | (P4[ 92] & C[ 92]);
        C[ 94] = G5[ 93] | (P4[ 93] & C[ 92]);
        C[ 95] = G5[ 94] | (P4[ 94] & C[ 94]);
        C[ 96] = cin;
        C[ 97] = G5[ 96] | (P4[ 96] & C[ 96]);
        C[ 98] = G5[ 97] | (P4[ 97] & C[ 96]);
        C[ 99] = G5[ 98] | (P4[ 98] & C[ 98]);
        C[100] = G5[ 99] | (P4[ 99] & C[ 96]);
        C[101] = G5[100] | (P4[100] & C[100]);
        C[102] = G5[101] | (P4[101] & C[100]);
        C[103] = G5[102] | (P4[102] & C[102]);
        C[104] = G5[103] | (P4[103] & C[ 96]);
        C[105] = G5[104] | (P4[104] & C[104]);
        C[106] = G5[105] | (P4[105] & C[104]);
        C[107] = G5[106] | (P4[106] & C[106]);
        C[108] = G5[107] | (P4[107] & C[104]);
        C[109] = G5[108] | (P4[108] & C[108]);
        C[110] = G5[109] | (P4[109] & C[108]);
        C[111] = G5[110] | (P4[110] & C[110]);
        C[112] = (word_mode == 1'b1) ? (G5[111] | (P4[111] & cin)) : cin;
        C[113] = G5[112] | (P4[112] & C[112]);
        C[114] = G5[113] | (P4[113] & C[112]);
        C[115] = G5[114] | (P4[114] & C[114]);
        C[116] = G5[115] | (P4[115] & C[112]);
        C[117] = G5[116] | (P4[116] & C[116]);
        C[118] = G5[117] | (P4[117] & C[116]);
        C[119] = G5[118] | (P4[118] & C[118]);
        C[120] = G5[119] | (P4[119] & C[112]);
        C[121] = G5[120] | (P4[120] & C[120]);
        C[122] = G5[121] | (P4[121] & C[120]);
        C[123] = G5[122] | (P4[122] & C[122]);
        C[124] = G5[123] | (P4[123] & C[120]);
        C[125] = G5[124] | (P4[124] & C[124]);
        C[126] = G5[125] | (P4[125] & C[124]);
        C[127] = G5[126] | (P4[126] & C[126]);
        C[128] = cin;
        C[129] = G5[128] | (P4[128] & C[128]);
        C[130] = G5[129] | (P4[129] & C[128]);
        C[131] = G5[130] | (P4[130] & C[130]);
        C[132] = G5[131] | (P4[131] & C[128]);
        C[133] = G5[132] | (P4[132] & C[132]);
        C[134] = G5[133] | (P4[133] & C[132]);
        C[135] = G5[134] | (P4[134] & C[134]);
        C[136] = G5[135] | (P4[135] & C[128]);
        C[137] = G5[136] | (P4[136] & C[136]);
        C[138] = G5[137] | (P4[137] & C[136]);
        C[139] = G5[138] | (P4[138] & C[138]);
        C[140] = G5[139] | (P4[139] & C[136]);
        C[141] = G5[140] | (P4[140] & C[140]);
        C[142] = G5[141] | (P4[141] & C[140]);
        C[143] = G5[142] | (P4[142] & C[142]);
        C[144] = (word_mode == 1'b1) ? (G5[143] | (P4[143] & cin)) : cin;
        C[145] = G5[144] | (P4[144] & C[144]);
        C[146] = G5[145] | (P4[145] & C[144]);
        C[147] = G5[146] | (P4[146] & C[146]);
        C[148] = G5[147] | (P4[147] & C[144]);
        C[149] = G5[148] | (P4[148] & C[148]);
        C[150] = G5[149] | (P4[149] & C[148]);
        C[151] = G5[150] | (P4[150] & C[150]);
        C[152] = G5[151] | (P4[151] & C[144]);
        C[153] = G5[152] | (P4[152] & C[152]);
        C[154] = G5[153] | (P4[153] & C[152]);
        C[155] = G5[154] | (P4[154] & C[154]);
        C[156] = G5[155] | (P4[155] & C[152]);
        C[157] = G5[156] | (P4[156] & C[156]);
        C[158] = G5[157] | (P4[157] & C[156]);
        C[159] = G5[158] | (P4[158] & C[158]);
        C[160] = cin;
        C[161] = G5[160] | (P4[160] & C[160]);
        C[162] = G5[161] | (P4[161] & C[160]);
        C[163] = G5[162] | (P4[162] & C[162]);
        C[164] = G5[163] | (P4[163] & C[160]);
        C[165] = G5[164] | (P4[164] & C[164]);
        C[166] = G5[165] | (P4[165] & C[164]);
        C[167] = G5[166] | (P4[166] & C[166]);
        C[168] = G5[167] | (P4[167] & C[160]);
        C[169] = G5[168] | (P4[168] & C[168]);
        C[170] = G5[169] | (P4[169] & C[168]);
        C[171] = G5[170] | (P4[170] & C[170]);
        C[172] = G5[171] | (P4[171] & C[168]);
        C[173] = G5[172] | (P4[172] & C[172]);
        C[174] = G5[173] | (P4[173] & C[172]);
        C[175] = G5[174] | (P4[174] & C[174]);
        C[176] = (word_mode == 1'b1) ? (G5[175] | (P4[175] & cin)) : cin;
        C[177] = G5[176] | (P4[176] & C[176]);
        C[178] = G5[177] | (P4[177] & C[176]);
        C[179] = G5[178] | (P4[178] & C[178]);
        C[180] = G5[179] | (P4[179] & C[176]);
        C[181] = G5[180] | (P4[180] & C[180]);
        C[182] = G5[181] | (P4[181] & C[180]);
        C[183] = G5[182] | (P4[182] & C[182]);
        C[184] = G5[183] | (P4[183] & C[176]);
        C[185] = G5[184] | (P4[184] & C[184]);
        C[186] = G5[185] | (P4[185] & C[184]);
        C[187] = G5[186] | (P4[186] & C[186]);
        C[188] = G5[187] | (P4[187] & C[184]);
        C[189] = G5[188] | (P4[188] & C[188]);
        C[190] = G5[189] | (P4[189] & C[188]);
        C[191] = G5[190] | (P4[190] & C[190]);
        C[192] = cin;
        C[193] = G5[192] | (P4[192] & C[192]);
        C[194] = G5[193] | (P4[193] & C[192]);
        C[195] = G5[194] | (P4[194] & C[194]);
        C[196] = G5[195] | (P4[195] & C[192]);
        C[197] = G5[196] | (P4[196] & C[196]);
        C[198] = G5[197] | (P4[197] & C[196]);
        C[199] = G5[198] | (P4[198] & C[198]);
        C[200] = G5[199] | (P4[199] & C[192]);
        C[201] = G5[200] | (P4[200] & C[200]);
        C[202] = G5[201] | (P4[201] & C[200]);
        C[203] = G5[202] | (P4[202] & C[202]);
        C[204] = G5[203] | (P4[203] & C[200]);
        C[205] = G5[204] | (P4[204] & C[204]);
        C[206] = G5[205] | (P4[205] & C[204]);
        C[207] = G5[206] | (P4[206] & C[206]);
        C[208] = (word_mode == 1'b1) ? (G5[207] | (P4[207] & cin)) : cin;
        C[209] = G5[208] | (P4[208] & C[208]);
        C[210] = G5[209] | (P4[209] & C[208]);
        C[211] = G5[210] | (P4[210] & C[210]);
        C[212] = G5[211] | (P4[211] & C[208]);
        C[213] = G5[212] | (P4[212] & C[212]);
        C[214] = G5[213] | (P4[213] & C[212]);
        C[215] = G5[214] | (P4[214] & C[214]);
        C[216] = G5[215] | (P4[215] & C[208]);
        C[217] = G5[216] | (P4[216] & C[216]);
        C[218] = G5[217] | (P4[217] & C[216]);
        C[219] = G5[218] | (P4[218] & C[218]);
        C[220] = G5[219] | (P4[219] & C[216]);
        C[221] = G5[220] | (P4[220] & C[220]);
        C[222] = G5[221] | (P4[221] & C[220]);
        C[223] = G5[222] | (P4[222] & C[222]);
        C[224] = cin;
        C[225] = G5[224] | (P4[224] & C[224]);
        C[226] = G5[225] | (P4[225] & C[224]);
        C[227] = G5[226] | (P4[226] & C[226]);
        C[228] = G5[227] | (P4[227] & C[224]);
        C[229] = G5[228] | (P4[228] & C[228]);
        C[230] = G5[229] | (P4[229] & C[228]);
        C[231] = G5[230] | (P4[230] & C[230]);
        C[232] = G5[231] | (P4[231] & C[224]);
        C[233] = G5[232] | (P4[232] & C[232]);
        C[234] = G5[233] | (P4[233] & C[232]);
        C[235] = G5[234] | (P4[234] & C[234]);
        C[236] = G5[235] | (P4[235] & C[232]);
        C[237] = G5[236] | (P4[236] & C[236]);
        C[238] = G5[237] | (P4[237] & C[236]);
        C[239] = G5[238] | (P4[238] & C[238]);
        C[240] = (word_mode == 1'b1) ? (G5[239] | (P4[239] & cin)) : cin;
        C[241] = G5[240] | (P4[240] & C[240]);
        C[242] = G5[241] | (P4[241] & C[240]);
        C[243] = G5[242] | (P4[242] & C[242]);
        C[244] = G5[243] | (P4[243] & C[240]);
        C[245] = G5[244] | (P4[244] & C[244]);
        C[246] = G5[245] | (P4[245] & C[244]);
        C[247] = G5[246] | (P4[246] & C[246]);
        C[248] = G5[247] | (P4[247] & C[240]);
        C[249] = G5[248] | (P4[248] & C[248]);
        C[250] = G5[249] | (P4[249] & C[248]);
        C[251] = G5[250] | (P4[250] & C[250]);
        C[252] = G5[251] | (P4[251] & C[248]);
        C[253] = G5[252] | (P4[252] & C[252]);
        C[254] = G5[253] | (P4[253] & C[252]);
        C[255] = G5[254] | (P4[254] & C[254]);
        C[256] = G5[255] | (P4[255] & C[127]);
    end

    // Step 4: Final sum
    always_comb begin
      unique case (word_mode)
        1'b0: begin
          for (int j = 0; j < 16; j++) begin
            sum[j*16 +: 16] = (G5[(j+1)*16-1] | (P5[(j+1)*16-1] & cin)) ? (P[j*16 +: 16] ^ C[j*16 +: 16]) : A[j*16 +: 16];
          end
        end
        1'b1: begin
          for (int j = 0; j < 8; j++) begin
            sum[j*32 +: 32] = (G5[(j+1)*32-1] | (P5[(j+1)*32-1] & cin)) ? (P[j*32 +: 32] ^ C[j*32 +: 32]) : A[j*32 +: 32];
          end
        end
      endcase
    end

    assign cout = 1'b0;

endmodule

